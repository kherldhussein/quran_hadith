name: CI - Analyze, Test, and Desktop Builds

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Lint, Analyze and Test (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux desktop deps (for later builds)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libkeybinder-3.0-dev \
            libayatana-appindicator3-dev

      - name: Flutter pub get
        run: flutter pub get

      #      - name: Format check
      # run: dart format --output=none --set-exit-if-changed .

      #- name: Analyze
      # run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test

      # - name: Build web (release)
      # run: flutter build web --release

      #      - name: Upload web artifact
      # uses: actions/upload-artifact@v4
      # with:
      # name: web-build
      # path: build/web

  build-desktop:
    name: Build Desktop (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: checks
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Linux deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libkeybinder-3.0-dev \
            libayatana-appindicator3-dev

      - name: Flutter pub get
        run: flutter pub get

      - name: Enable desktop target
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            flutter config --enable-linux-desktop
          else
            flutter config --enable-windows-desktop
          fi
        shell: bash

      - name: Build desktop
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            flutter build linux --release
          else
            flutter build windows --release
          fi
        shell: bash

      - name: Package Linux artifact
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd build/linux/x64/release
          zip -r ../../../linux-x64.zip bundle
        shell: bash

      - name: Build Debian package
        if: matrix.os == 'ubuntu-latest'
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          set -euo pipefail
          APP_ID="quran-hadith"
          APP_EXEC="quran_hadith"
          BUILD_DIR="build/linux/x64/release/bundle"
          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "Bundle directory not found at $BUILD_DIR" >&2
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME:-0.0.0}"
          if [[ ! "${GITHUB_REF}" =~ ^refs/tags/ ]]; then
            VERSION="0.0.0~dev${GITHUB_RUN_NUMBER}"
          fi
          VERSION="${VERSION#v}"

          STAGING_ROOT="build/linux/x64/release/debian"
          STAGING="$STAGING_ROOT/${APP_ID}_${VERSION}_amd64"
          rm -rf "$STAGING"
          mkdir -p "$STAGING/DEBIAN"
          mkdir -p "$STAGING/usr/bin"
          mkdir -p "$STAGING/usr/share/applications"
          mkdir -p "$STAGING/usr/share/icons/hicolor/512x512/apps"
          mkdir -p "$STAGING/opt/${APP_ID}"

          cp -r "$BUILD_DIR"/* "$STAGING/opt/${APP_ID}/"

          ln -sf "/opt/${APP_ID}/${APP_EXEC}" "$STAGING/usr/bin/${APP_ID}"

          if [[ -f assets/images/Logo.png ]]; then
            cp assets/images/Logo.png "$STAGING/usr/share/icons/hicolor/512x512/apps/${APP_ID}.png"
          fi

          printf '%s\n' \
            '[Desktop Entry]' \
            'Version=1.0' \
            'Type=Application' \
              "Name=Qur'an & Hadith" \
            "Comment=Read and listen to the Qur'an and Hadith collections" \
            "Exec=${APP_ID} %U" \
            "Icon=${APP_ID}" \
            'Terminal=false' \
            'Categories=Education;Utility;' \
            > "$STAGING/usr/share/applications/${APP_ID}.desktop"

          INSTALLED_SIZE=$(du -ks "$STAGING/opt/${APP_ID}" | cut -f1)
          printf '%s\n' \
            "Package: ${APP_ID}" \
            "Version: ${VERSION}" \
              "Section: misc" \
              "Priority: optional" \
              "Architecture: amd64" \
              "Depends: libgtk-3-0, libayatana-appindicator3-1, libstdc++6, liblzma5" \
              "Maintainer: Quran Hadith Team <support@quran-hadith.app>" \
              "Installed-Size: ${INSTALLED_SIZE}" \
              "Description: Quran & Hadith desktop application built with Flutter." \
              " This package provides the Qur'an & Hadith desktop experience with offline audio playback." \
            > "$STAGING/DEBIAN/control"

          printf '%s\n' \
            '#!/usr/bin/env bash' \
            'set -e' \
            'if command -v update-desktop-database >/dev/null 2>&1; then' \
            '  update-desktop-database -q /usr/share/applications || true' \
            'fi' \
            'if command -v gtk-update-icon-cache >/dev/null 2>&1; then' \
            '  gtk-update-icon-cache -q /usr/share/icons/hicolor || true' \
            'fi' \
            'exit 0' \
            > "$STAGING/DEBIAN/postinst"
          chmod 0755 "$STAGING/DEBIAN/postinst"

          dpkg-deb --build "$STAGING" "${APP_ID}_${VERSION}_amd64.deb"

      - name: Package Windows artifact
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $releaseDir = Get-ChildItem -Path build\windows -Recurse -Directory -Filter Release | Select-Object -First 1
          if ($null -eq $releaseDir) { throw "Release directory not found under build\\windows" }
          Compress-Archive -Path (Join-Path $releaseDir.FullName '*') -DestinationPath windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-desktop
          path: |
            windows-x64.zip
            build/linux/x64/release/bundle
            linux-x64.zip
            *.deb
          if-no-files-found: warn

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [checks, build-desktop]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout for changelog
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        run: |
          set -euo pipefail
          temp_dir=$(mktemp -d)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          url=$(curl -sSfL https://api.github.com/repos/orhun/git-cliff/releases/latest \
            | jq -r '.assets[] | select(.name | contains("x86_64-unknown-linux-gnu.tar.gz")) | .browser_download_url' \
            | head -n 1)
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Unable to determine git-cliff release asset" >&2
            exit 1
          fi
          curl -sSL "$url" -o "$temp_dir/git-cliff.tar.gz"
          tar -xzf "$temp_dir/git-cliff.tar.gz" -C "$temp_dir"
          binary=$(find "$temp_dir" -type f -name git-cliff -perm -o+x | head -n 1)
          if [ -z "$binary" ]; then
            echo "git-cliff binary not found in archive" >&2
            exit 1
          fi
          sudo install -m 0755 "$binary" /usr/local/bin/git-cliff

      - name: Generate changelog (git-cliff)
        run: git-cliff --config cliff.toml --tag "${{ github.ref_name }}" --strip all --output RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-desktop"
          merge-multiple: true

      - name: List downloaded files
        run: ls -R

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            linux-x64.zip
            windows-x64.zip
            quran-hadith_*.deb
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

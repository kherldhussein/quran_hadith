name: CI - Analyze, Test, and Desktop Builds

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Lint, Analyze and Test (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Linux desktop deps (for later builds)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libkeybinder-3.0-dev \
            libayatana-appindicator3-dev

      - name: Flutter pub get
        run: flutter pub get

      #      - name: Format check
      # run: dart format --output=none --set-exit-if-changed .

      #- name: Analyze
      # run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test

      # - name: Build web (release)
      # run: flutter build web --release

      #      - name: Upload web artifact
      # uses: actions/upload-artifact@v4
      # with:
      # name: web-build
      # path: build/web

  build-desktop:
    name: Build Desktop (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: checks
    timeout-minutes: 40
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Linux deps
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            liblzma-dev \
            libkeybinder-3.0-dev \
            libayatana-appindicator3-dev

      - name: Flutter pub get
        run: flutter pub get

      - name: Enable desktop target
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            flutter config --enable-linux-desktop
          else
            flutter config --enable-windows-desktop
          fi
        shell: bash

      - name: Build desktop
        run: |
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            flutter build linux --release
          else
            flutter build windows --release
          fi
        shell: bash

      - name: Package Linux artifact
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd build/linux/x64/release
          zip -r ../../../linux-x64.zip bundle
        shell: bash

      - name: Package Windows artifact
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          $releaseDir = Get-ChildItem -Path build\windows -Recurse -Directory -Filter Release | Select-Object -First 1
          if ($null -eq $releaseDir) { throw "Release directory not found under build\\windows" }
          Compress-Archive -Path (Join-Path $releaseDir.FullName '*') -DestinationPath windows-x64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-desktop
          path: |
            windows-x64.zip
            build/linux/x64/release/bundle
            linux-x64.zip
          if-no-files-found: warn

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [checks, build-desktop]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout for changelog
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-cliff
        run: |
          set -euo pipefail
          temp_dir=$(mktemp -d)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          url=$(curl -sSfL https://api.github.com/repos/orhun/git-cliff/releases/latest \
            | jq -r '.assets[] | select(.name | contains("x86_64-unknown-linux-gnu.tar.gz")) | .browser_download_url' \
            | head -n 1)
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Unable to determine git-cliff release asset" >&2
            exit 1
          fi
          curl -sSL "$url" -o "$temp_dir/git-cliff.tar.gz"
          tar -xzf "$temp_dir/git-cliff.tar.gz" -C "$temp_dir"
          binary=$(find "$temp_dir" -type f -name git-cliff -perm -o+x | head -n 1)
          if [ -z "$binary" ]; then
            echo "git-cliff binary not found in archive" >&2
            exit 1
          fi
          sudo install -m 0755 "$binary" /usr/local/bin/git-cliff

      - name: Generate changelog (git-cliff)
        run: git-cliff --config cliff.toml --tag "${{ github.ref_name }}" --strip all --output RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-desktop"
          merge-multiple: true

      - name: List downloaded files
        run: ls -R

      - name: Create Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            linux-x64.zip
            windows-x64.zip
          body_path: RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

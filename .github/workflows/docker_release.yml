name: Release Docker Images

on:
  push:
    tags:
      - "v*"

concurrency:
  group: docker-release-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: quran-hadith

jobs:
  build-and-push:
    name: Build and push container
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate version metadata
        id: vars
        run: |
          version="${GITHUB_REF#refs/tags/}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Detect Docker credentials
        id: dockercfg
        shell: bash
        run: |
          if [[ -n '${{ secrets.DOCKER_USERNAME }}' && -n '${{ secrets.DOCKER_PASSWORD }}' ]]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
            echo "username=${{ secrets.DOCKER_USERNAME }}" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        if: ${{ steps.dockercfg.outputs.available == 'true' }}
        run: |
          echo '${{ secrets.DOCKER_PASSWORD }}' | docker login --username '${{ steps.dockercfg.outputs.username }}' --password-stdin

      - name: Prepare image tags
        id: prep
        env:
          DOCKER_USERNAME: ${{ steps.dockercfg.outputs.username }}
        run: |
          version="${GITHUB_REF#refs/tags/}"
          owner="${GITHUB_REPOSITORY_OWNER}"
          owner=$(echo "$owner" | tr '[:upper:]' '[:lower:]')

          tags="ghcr.io/${owner}/${IMAGE_NAME}:${version}\n"
          tags+="ghcr.io/${owner}/${IMAGE_NAME}:latest"

          if [ -n "$DOCKER_USERNAME" ]; then
            tags+="\n${DOCKER_USERNAME}/${IMAGE_NAME}:${version}"
            tags+="\n${DOCKER_USERNAME}/${IMAGE_NAME}:latest"
          fi

          printf 'tags<<EOF\n%s\nEOF\n' "$tags" >> "$GITHUB_OUTPUT"

      - name: Extract metadata for OCI labels
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=tag
            type=raw,value=latest

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.prep.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Summarize release
        if: ${{ success() }}
        run: |
          printf 'Published container tags:\n%s\n' "${{ steps.prep.outputs.tags }}"
